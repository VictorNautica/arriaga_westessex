library(readr)
library(readxl)
library(fingertipsR)
library(tidyverse)
library(PHEindicatormethods)
library(RColorBrewer)

options(scipen = 999999)

fetch_deaths <- F

LAD_2021 <- read_excel("data/public/LAD_DEC_2021_UK_NC.xlsx") %>% select(1:2)

county_code <- county

## WEST ESSEX USE ####
age_bands <- structure(list(Age = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120), `<1, 5yr, 90+` = c("0", "01 - 04", "01 - 04", "01 - 04", "01 - 04", "05 - 09", "05 - 09", "05 - 09", "05 - 09", "05 - 09", "10 - 14", "10 - 14", "10 - 14", "10 - 14", "10 - 14", "15 - 19", "15 - 19", "15 - 19", "15 - 19", "15 - 19", "20 - 24", "20 - 24", "20 - 24", "20 - 24", "20 - 24", "25 - 29", "25 - 29", "25 - 29", "25 - 29", "25 - 29", "30 - 34", "30 - 34", "30 - 34", "30 - 34", "30 - 34", "35 - 39", "35 - 39", "35 - 39", "35 - 39", "35 - 39", "40 - 44", "40 - 44", "40 - 44", "40 - 44", "40 - 44", "45 - 49", "45 - 49", "45 - 49", "45 - 49", "45 - 49", "50 - 54", "50 - 54", "50 - 54", "50 - 54", "50 - 54", "55 - 59", "55 - 59", "55 - 59", "55 - 59", "55 - 59", "60 - 64", "60 - 64", "60 - 64", "60 - 64", "60 - 64", "65 - 69", "65 - 69", "65 - 69", "65 - 69", "65 - 69", "70 - 74", "70 - 74", "70 - 74", "70 - 74", "70 - 74", "75 - 79", "75 - 79", "75 - 79", "75 - 79", "75 - 79", "80 - 84", "80 - 84", "80 - 84", "80 - 84", "80 - 84", "85 - 89", "85 - 89", "85 - 89", "85 - 89", "85 - 89", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+", "90+"), `<1, 1-19, 20-49, 50-69, 70+` = c("0", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "1-19", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "20-49", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "50-69", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+", "70+")), row.names = c(NA, -121L), class = c("tbl_df", "tbl", "data.frame"))

## WEST ESSEX USE ####

lsoa_herts <- read_rds("data/public/lsoa_west_essex.Rds")

herts_imd <- read_excel("data/public/File_1_-_IMD2019_Index_of_Multiple_Deprivation.xlsx",
                        sheet = "IMD2019") %>% 
  rename(`LSOA Code` = `LSOA code (2011)`,
         `District` = `Local Authority District name (2019)`,
         `IMD Rank` = `Index of Multiple Deprivation (IMD) Rank`) %>% 
  select(`LSOA Code`, District, `IMD Rank`) %>% 
  filter(District %in% c("Uttlesford", "Harlow", "Epping Forest")) %>% 
  phe_quantile(values = `IMD Rank`, nquantiles = 5, invert = F, type = "standard") %>% 
           rename("Herts IMD 2019 Quintile" = "quantile")
  

source("R/01.1_deaths_WE.R")
source("R/01.2_gp_lsoa_populations.R")
source("R/01.3_deaths_formatting_WE.R")
source("R/01.4_populations_WE.R")
source("R/01.5_join_deaths_populations.R")
source("R/01.6_phe_life_expectancy.R")
source("R/01.9_deaths_WE.R")

rm(deaths)

save.image("arriaga_westessex.Rdata")
